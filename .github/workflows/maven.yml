name: Create release

on:
#    milestone:
#        types: [closed]
  push:
    branches: [ master ]
#  pull_request:
#    branches: [ master ]

jobs:
  
  build-linux:

    runs-on: ubuntu-latest

    steps:

    - uses: actions/checkout@v2
    - name: Set up JDK 14
      uses: actions/setup-java@v1
      with:
        java-version: 14
    - name: Build with Maven
      run: java -version ; mvn -X clean install resources:resources compiler:compile javafx:jlink --file pom.xml
    - name: Create DEB
      run: jpackage -n notepack --runtime-image target/notepack/ -m notepack/notepack.Main -d notepack.deb --type deb --java-options '-Xms256m -Xmx2g' --linux-deb-maintainer hello@ogefest.com --linux-shortcut --description 'Notepack - Privacy oriented, without vendor lock in note taking desktop application' --linux-menu-group Office --vendor Ogefest --icon gfx/logo_128.png --license-file LICENSE

    - name: Create RPM
      run: jpackage -n notepack --runtime-image target/notepack/ -m notepack/notepack.Main -d notepack.rpm --type rpm --java-options '-Xms256m -Xmx2g' --linux-shortcut --linux-rpm-license-type MPLv2.0 --description 'Notepack - Privacy oriented, without vendor lock in note taking desktop application' --linux-menu-group Office --vendor Ogefest --icon gfx/logo_128.png --license-file LICENSE --linux-app-category Office
      
    - name: Download appimage
      run: wget -O appimagetool "https://github.com/AppImage/AppImageKit/releases/download/12/appimagetool-x86_64.AppImage"
    - name: Build appimage
      run: cp -r target/notepack/ appimage-base-dir/ ; chmod +x appimagetool ; ./appimagetool appimage-base-dir/ notepack.AppImage
      
    - name: Upload runtime image
      uses: actions/upload-artifact@v1
      with:
        name: release-linux.zip
        path: target/notepack
        
    - name: Upload appimage
      uses: actions/upload-artifact@v1
      with:
        name: notepack-appimage
        path: notepack.AppImage
        
    - name: Upload DEB
      uses: actions/upload-artifact@v1
      with:
        name: notepack-deb
        path: notepack.deb
        
    - name: Upload RPM
      uses: actions/upload-artifact@v1
      with:
        name: notepack-rpm
        path: notepack.rpm


  build-windows:

    runs-on: windows-latest

    steps:
      
    - uses: actions/checkout@v2
    - name: Set up JDK 14
      uses: actions/setup-java@v1
      with:
        java-version: 14

    - name: Build with Maven
      run: java -version ; mvn -X clean install resources:resources compiler:compile javafx:jlink --file pom.xml
    - name: Create jpackage
      run: jpackage -n notepack --runtime-image target/notepack/ --java-options '-Xms256m -Xmx2g' -m notepack/notepack.Main --icon gfx/logo_64.ico --win-dir-chooser --win-shortcut --win-menu --win-menu-group NotePack -d notepack.msi --vendor Ogefest --license-file LICENSE
    - name: Archive production artifacts zip
      uses: actions/upload-artifact@v1
      with:
        name: release-windows.zip
        path: target/notepack
    - name: Archive production artifacts msi
      uses: actions/upload-artifact@v1
      with:
        name: notepack-windows
        path: notepack.msi 

